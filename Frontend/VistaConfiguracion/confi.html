<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdminXpress</title>
    <link rel="stylesheet" href="configuracion.css">
</head>
<body>

<nav class="navbar">
        <div class="logo">
            <div class="logo-icon">
                <img src="purologito.svg" alt="logo">
            </div>
            <span>AdminXpress</span>
        </div>
        
        <div class="tabs-container">
    <a href="/Ventas/ind3..html" class="tab-link">
        <div class="tab-svg-inline">
            <svg width="207" height="57" viewBox="0 0 207 57" fill="none">
                <path d="M12.6502 5.94966C14.0433 1.9203 17.8379 -0.782715 22.1013 -0.782715H183.738C188.056 -0.782715 191.886 1.98855 193.236 6.0897L205.677 43.8725C207.807 50.341 202.989 57 196.179 57H9.03823C2.16578 57 -2.65849 50.2276 -0.412837 43.7324L12.6502 5.94966Z" fill="#549274"/>
            </svg>
            <div class="tab-text">
                <svg class="tab-icon" viewBox="0 0 24 24">
                    <path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2.5-9H18V0h-2v2H8V0H6v2H3.5C2.67 2 2 2.67 2 3.5v16C2 20.33 2.67 21 3.5 21h15c.83 0 1.5-.67 1.5-1.5v-16C20 2.67 19.33 2 18.5 2z"/>
                </svg>
                <img src="carrito.svg" alt="carrito de compras">
                Ventas
            </div>
        </div> 
    </a>
     <a href="/HTML/VistaProductos/index.html" class="tab-link">
        <div class="tab-svg-inline">
            <svg width="207" height="57" viewBox="0 0 207 57" fill="none">
                <path d="M12.6502 5.94966C14.0433 1.9203 17.8379 -0.782715 22.1013 -0.782715H183.738C188.056 -0.782715 191.886 1.98855 193.236 6.0897L205.677 43.8725C207.807 50.341 202.989 57 196.179 57H9.03823C2.16578 57 -2.65849 50.2276 -0.412837 43.7324L12.6502 5.94966Z" fill="#549274"/>
            </svg>
            <div class="tab-text">
                <svg class="tab-icon" viewBox="0 0 24 24">
                    <path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2.5-9H18V0h-2v2H8V0H6v2H3.5C2.67 2 2 2.67 2 3.5v16C2 20.33 2.67 21 3.5 21h15c.83 0 1.5-.67 1.5-1.5v-16C20 2.67 19.33 2 18.5 2z"/>
                </svg>
                <img src="Frame.svg" alt="carrito de compras">
                Productos
            </div>
        </div>
    </a>  
    <a href="/Reportes/Reportes.html" class="tab-link">
        <div class="tab-svg-inline">
            <svg width="207" height="57" viewBox="0 0 207 57" fill="none">
                <path d="M12.6502 5.94966C14.0433 1.9203 17.8379 -0.782715 22.1013 -0.782715H183.738C188.056 -0.782715 191.886 1.98855 193.236 6.0897L205.677 43.8725C207.807 50.341 202.989 57 196.179 57H9.03823C2.16578 57 -2.65849 50.2276 -0.412837 43.7324L12.6502 5.94966Z" fill="#549274"/>
            </svg>
            <div class="tab-text">
                <svg class="tab-icon" viewBox="0 0 24 24">
                    <path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2.5-9H18V0h-2v2H8V0H6v2H3.5C2.67 2 2 2.67 2 3.5v16C2 20.33 2.67 21 3.5 21h15c.83 0 1.5-.67 1.5-1.5v-16C20 2.67 19.33 2 18.5 2z"/>
                </svg>
                <img src="reportes.svg" alt="carrito de compras">
                Reportes
            </div>
        </div>
    </a>
    <a href="/Vista insumos/insumo.html" class="tab-link">
        <div class="tab-svg-inline">
            <svg width="207" height="57" viewBox="0 0 207 57" fill="none">
                <path d="M12.6502 5.94966C14.0433 1.9203 17.8379 -0.782715 22.1013 -0.782715H183.738C188.056 -0.782715 191.886 1.98855 193.236 6.0897L205.677 43.8725C207.807 50.341 202.989 57 196.179 57H9.03823C2.16578 57 -2.65849 50.2276 -0.412837 43.7324L12.6502 5.94966Z" fill="#549274"/>
            </svg>
            <div class="tab-text">
                <svg class="tab-icon" viewBox="0 0 24 24">
                    <path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2.5-9H18V0h-2v2H8V0H6v2H3.5C2.67 2 2 2.67 2 3.5v16C2 20.33 2.67 21 3.5 21h15c.83 0 1.5-.67 1.5-1.5v-16C20 2.67 19.33 2 18.5 2z"/>
                </svg>
                <img src="insumos.svg" alt="carrito de compras">
                Insumos 
            </div>
        </div>
    </a>
    <a href="/VistaConfiguracion/confi.html" class="tab-link">
        <div class="tab-svg-inline">
            <svg width="207" height="57" viewBox="0 0 207 57" fill="none">
                <path d="M12.6502 5.94966C14.0433 1.9203 17.8379 -0.782715 22.1013 -0.782715H183.738C188.056 -0.782715 191.886 1.98855 193.236 6.0897L205.677 43.8725C207.807 50.341 202.989 57 196.179 57H9.03823C2.16578 57 -2.65849 50.2276 -0.412837 43.7324L12.6502 5.94966Z" fill="#549274"/>
            </svg>
            <div class="tab-text">
                <svg class="tab-icon" viewBox="0 0 24 24">
                    <path d="M9 11H7v6h2v-6zm4 0h-2v6h2v-6zm4 0h-2v6h2v-6zm2.5-9H18V0h-2v2H8V0H6v2H3.5C2.67 2 2 2.67 2 3.5v16C2 20.33 2.67 21 3.5 21h15c.83 0 1.5-.67 1.5-1.5v-16C20 2.67 19.33 2 18.5 2z"/>
                </svg>
                <img src="configuracion.svg" alt="carrito de compras">
                Configuracion
            </div>
        </div>
      </a>
    </div>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
        <div class="content-header">
            <a href="Documento de prueba para el proyecto.pdf" download class="section-title section-title-download">
                Documentación
            </a>
            <div class="action-buttons">
                <button class="btn btn-edit" disabled>Editar</button>
                <button class="btn btn-add">Agregar</button>
                <button class="btn btn-delete" disabled>Eliminar</button>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Identificador</th>
                        <th>Usuario</th>
                        <th>Nombre</th>
                        <th>CURP</th>   
                        <th>Cargo</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>001</td>
                        <td>juan.garcia</td>
                        <td>Juan Carlos García López</td>
                        <td>GALJ850315HDFRRN01</td>
                        <td>Administrador</td>
                    </tr>
                    <tr>
                        <td>002</td>
                        <td>maria.martinez</td>
                        <td>María Elena Martínez Rodríguez</td>
                        <td>MARE900422MDFTRN02</td>
                        <td>Cajero</td>
                    </tr>
                    <tr>
                        <td>003</td>
                        <td>carlos.hernandez</td>
                        <td>Carlos Alberto Hernández Sánchez</td>
                        <td>HESC920108HDFRRN03</td>
                        <td>Cajero</td>
                    </tr>
                    <tr>
                        <td>004</td>
                        <td>ana.gonzalez</td>
                        <td>Ana Patricia González Flores</td>
                        <td>GOFA880725MDFNRN04</td>
                        <td>Administrador</td>
                    </tr>
                    <tr>
                        <td>005</td>
                        <td>roberto.jimenez</td>
                        <td>Roberto Jiménez Torres</td>
                        <td>JITR950312HDFMRN05</td>
                        <td>Cajero</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal de Agregar Usuario -->
    <div class="modal-overlay" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Agregar un usuario</h2>
                <button class="close-btn" id="closeModal">×</button>
            </div>
            <div class="modal-body">
                <form id="userForm">
                    <div class="form-group">
                        <label for="nombre">Nombre</label>
                        <input type="text" id="nombre" class="form-input" placeholder="Ingrese su nombre(s)">
                        <span class="error-message" id="nombreError"></span>
                    </div>

                    <div class="form-group">
                        <label for="apellidoPaterno">Apellido Paterno</label>
                        <input type="text" id="apellidoPaterno" class="form-input" placeholder="Ingrese su apellido">
                        <span class="error-message" id="apellidoPaternoError"></span>
                    </div>

                    <div class="form-group">
                        <label for="apellidoMaterno">Apellido Materno</label>
                        <input type="text" id="apellidoMaterno" class="form-input" placeholder="Ingrese su apellido">
                        <span class="error-message" id="apellidoMaternoError"></span>
                    </div>

                    <div class="form-group">
                        <label for="username">Usuario</label>
                        <input type="text" id="username" class="form-input" placeholder="Ingrese un nombre de usuario">
                        <span class="error-message" id="usernameError"></span>
                    </div>

                    <div class="form-group">
                        <label for="curp">CURP</label>
                        <input type="text" id="curp" class="form-input" placeholder="Ingrese su CURP" maxlength="18">
                        <span class="error-message" id="curpError"></span>
                    </div>

                    <div class="form-group">
                        <label for="contrasena">Contraseña</label>
                        <input type="password" id="contrasena" class="form-input" placeholder="Ingrese una contraseña">
                        <span class="error-message" id="contrasenaError"></span>
                    </div>

                    <div class="form-group">
                        <label for="cargo">Cargo</label>
                        <select id="cargo" class="form-select">
                            <option value="">Seleccione un cargo</option>
                            <option value="administrador">Administrador</option>
                            <option value="Cajero">Cajero</option>
                        </select>
                        <span class="error-message" id="cargoError"></span>
                    </div>

                    <button type="submit" class="register-btn">Registrar</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal de Editar Usuario -->
    <div class="modal-overlay" id="editModal">
        <div class="modal-content edit-modal">
            <div class="modal-header edit-header">
                <h2 class="modal-title">Editar usuario</h2>
                <button class="close-btn" id="closeEditModal">×</button>
            </div>
            <div class="modal-body">
                <form id="editUserForm">
                    <div class="form-group">
                        <label for="editNombre">Nombre</label>
                        <input type="text" id="editNombre" class="form-input" placeholder="Ingrese su nombre(s)">
                        <span class="error-message" id="editNombreError"></span>
                    </div>

                    <div class="form-group">
                        <label for="editApellidoPaterno">Apellido Paterno</label>
                        <input type="text" id="editApellidoPaterno" class="form-input" placeholder="Ingrese su apellido">
                        <span class="error-message" id="editApellidoPaternoError"></span>
                    </div>

                    <div class="form-group">
                        <label for="editApellidoMaterno">Apellido Materno</label>
                        <input type="text" id="editApellidoMaterno" class="form-input" placeholder="Ingrese su apellido">
                        <span class="error-message" id="editApellidoMaternoError"></span>
                    </div>

                    <div class="form-group">
                        <label for="editUsername">Usuario</label>
                        <input type="text" id="editUsername" class="form-input" placeholder="Ingrese un nombre de usuario">
                        <span class="error-message" id="editUsernameError"></span>
                    </div>

                    <div class="form-group">
                        <label for="editCurp">CURP</label>
                        <input type="text" id="editCurp" class="form-input" placeholder="Ingrese su CURP" maxlength="18">
                        <span class="error-message" id="editCurpError"></span>
                    </div>

                    <div class="form-group">
                        <label for="editContrasena">Contraseña</label>
                        <input type="password" id="editContrasena" class="form-input" placeholder="Ingrese una nueva contraseña">
                        <span class="error-message" id="editContrasenaError"></span>
                    </div>

                    <div class="form-group">
                        <label for="editCargo">Cargo</label>
                        <select id="editCargo" class="form-select">
                            <option value="">Seleccione un cargo</option>
                            <option value="administrador">Administrador</option>
                            <option value="Cajero">Cajero</option>
                        </select>
                        <span class="error-message" id="editCargoError"></span>
                    </div>

                    <button type="submit" class="edit-btn">Guardar Cambios</button>
                </form>
            </div>
        </div>
    </div>

    <script>
let selectedRow = null;
let selectedUserId = null;



const userData = JSON.parse(localStorage.getItem('userData'));
const codigoNegocio = userData?.codigo_negocio;


if (!codigoNegocio) {
    alert("Error: No se encontró el código del negocio. Inicia sesión nuevamente.");
    window.location.href = "/Sesion.html"; 
}

function cargarUsuarios() {
    fetch(`http://localhost:7000/api/negocio/${codigoNegocio}/usuarios`)
         
        .then(res => res.json())
        .then(data => {
            const tbody = document.querySelector(".data-table tbody");
            tbody.innerHTML = "";

            data.forEach(usuario => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${usuario.id}</td>
                    <td>${usuario.usuario}</td>
                    <td>${usuario.nombre} ${usuario.apellidoPaterno} ${usuario.apellidoMaterno}</td>
                    <td>${usuario.curp}</td>
                    <td>${usuario.cargo.charAt(0).toUpperCase() + usuario.cargo.slice(1)}</td>
                `;
                row.addEventListener("click", () => seleccionarFila(row, usuario.id));
                tbody.appendChild(row);
            });

            // Deshabilitar botones y quitar selección al recargar
            selectedRow = null;
            selectedUserId = null;
            document.querySelector('.btn-edit').disabled = true;
            document.querySelector('.btn-delete').disabled = true;
        })
        .catch(err => console.error("Error cargando usuarios:", err));
}

function seleccionarFila(row, id) {
    if (selectedRow) selectedRow.classList.remove('selected');
    row.classList.add('selected');
    selectedRow = row;
    selectedUserId = id;
    document.querySelector('.btn-edit').disabled = false;
    document.querySelector('.btn-delete').disabled = false;
}

// Manejo modal abrir/cerrar (agregar)
const btnAdd = document.querySelector('.btn-add');
const userModal = document.getElementById('userModal');
const closeModalBtn = document.getElementById('closeModal');

btnAdd.addEventListener('click', () => {
    userModal.classList.add('active');
});

closeModalBtn.addEventListener('click', () => {
    userModal.classList.remove('active');
});

// Agregar usuario
const userForm = document.getElementById('userForm');
userForm.addEventListener('submit', e => {
    e.preventDefault();

    const nuevoUsuario = {
        nombre: document.getElementById('nombre').value.trim(),
        apellidoPaterno: document.getElementById('apellidoPaterno').value.trim(),
        apellidoMaterno: document.getElementById('apellidoMaterno').value.trim(),
        usuario: document.getElementById('username').value.trim(),
        curp: document.getElementById('curp').value.trim(),
        contrasena: document.getElementById('contrasena').value.trim(),
        cargo: document.getElementById('cargo').value.trim(),
        codigoNegocio: codigoNegocio 
    };

    fetch("http://localhost:7000/api/usuarios", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(nuevoUsuario)
    })
    .then(res => {
        if (!res.ok) throw new Error("Error al registrar usuario");
        return res.json();
    })
    .then(() => {
        alert("Usuario registrado exitosamente");
        userForm.reset();
        userModal.classList.remove('active');
        cargarUsuarios();
    })
    .catch(err => {
        alert("Error al registrar usuario");
        console.error(err);
    });
});

// Editar usuario: abrir modal y cargar datos
const btnEdit = document.querySelector('.btn-edit');
const editModal = document.getElementById('editModal');
const closeEditModalBtn = document.getElementById('closeEditModal');
const editForm = document.getElementById('editUserForm');

btnEdit.addEventListener('click', () => {
    if (!selectedUserId) {
        alert("Seleccione un usuario para editar");
        return;
    }

    // Cargar datos en el formulario
    const cells = selectedRow.cells;
    // Suponiendo que el nombre completo está separado por espacios en el campo nombre completo (celda 2)
    const nombres = cells[2].textContent.split(' ');
    document.getElementById('editNombre').value = nombres[0] || '';
    document.getElementById('editApellidoPaterno').value = nombres[1] || '';
    document.getElementById('editApellidoMaterno').value = nombres.slice(2).join(' ') || ''; // junta lo que queda
    document.getElementById('editUsername').value = cells[1].textContent;
    document.getElementById('editCurp').value = cells[3].textContent;
    document.getElementById('editCargo').value = cells[4].textContent.toLowerCase();
    document.getElementById('editContrasena').value = '';

    editModal.classList.add('active');
});

closeEditModalBtn.addEventListener('click', () => {
    editModal.classList.remove('active');
});

// Guardar cambios editar usuario
editForm.addEventListener('submit', e => {
    e.preventDefault();

    if (!selectedUserId) {
        alert("No hay usuario seleccionado");
        return;
    }

    const usuarioEditado = {
        nombre: document.getElementById('editNombre').value.trim(),
        apellidoPaterno: document.getElementById('editApellidoPaterno').value.trim(),
        apellidoMaterno: document.getElementById('editApellidoMaterno').value.trim(),
        usuario: document.getElementById('editUsername').value.trim(),
        curp: document.getElementById('editCurp').value.trim(),
        cargo: document.getElementById('editCargo').value
    };

    const pass = document.getElementById('editContrasena').value.trim();
    if (pass !== "") {
        usuarioEditado.contrasena = pass; // Solo enviar si cambió contraseña
    }

    fetch(`http://localhost:7000/api/usuarios/${selectedUserId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(usuarioEditado)
    })
    .then(res => {
        if (!res.ok) throw new Error("Error al actualizar usuario");
        return res.json();
    })
    .then(() => {
        alert("Usuario actualizado exitosamente");
        editForm.reset();
        editModal.classList.remove('active');
        cargarUsuarios();
    })
    .catch(err => {
        alert("Error al actualizar usuario");
        console.error(err);
    });
});

// Eliminar usuario
const btnDelete = document.querySelector('.btn-delete');
btnDelete.addEventListener('click', () => {
    if (!selectedUserId) {
        alert("Seleccione un usuario para eliminar");
        return;
    }
    if (confirm(`¿Está seguro que desea eliminar al usuario "${selectedRow.cells[2].textContent}"?`)) {
        fetch(`http://localhost:7000/api/usuarios/${selectedUserId}`, {
            method: "DELETE"
        })
        .then(res => {
            if (!res.ok) throw new Error("Error al eliminar usuario");
            alert("Usuario eliminado exitosamente");
            cargarUsuarios();
        })
        .catch(err => {
            alert("Error al eliminar usuario");
            console.error(err);
        });
    }
});

// Cargar usuarios cuando la página termina de cargar
document.addEventListener('DOMContentLoaded', cargarUsuarios);

</script>

</body>
</html>